{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-bold">Upload & Genera</h1>
<p class="text-gray-600 mt-1">Incolla un testo, aggiungi un URL e/o trascina più file. Poi clicca “Genera”.</p>

<form method="post" action="/generate" enctype="multipart/form-data" class="mt-6 grid gap-6" onsubmit="showOverlay()">
  <label class="block">
    <span class="text-sm font-medium">Testo</span>
    <textarea name="text_input" rows="6" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-600"
              placeholder="Incolla qui il contenuto da comunicare…"></textarea>
  </label>

  <label class="block">
    <span class="text-sm font-medium">URL di un articolo (opzionale)</span>
    <input type="url" name="url_input" placeholder="https://..."
           class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-600">
  </label>

  <div>
    <span class="text-sm font-medium">Allegati (trascina qui più file)</span>
    <div id="dropzone" class="mt-1 border-2 border-dashed rounded-xl p-6 text-center text-gray-600">
      Trascina qui uno o più file (PDF, DOCX, TXT) oppure clicca
      <div class="mt-3">
        <button type="button" id="btn-choose"
                class="px-3 py-1.5 rounded-lg bg-gray-100 border">Scegli file</button>
      </div>
      <input id="file-input" type="file" name="files" multiple class="hidden" />
    </div>
    <div id="file-list" class="mt-3 space-y-3" aria-live="polite"></div>
  </div>

  <label class="inline-flex items-center gap-2">
    <input type="checkbox" name="split_x">
    <span class="text-sm">Dividi “Social” in thread da 280 caratteri (X)</span>
  </label>

  <div class="flex flex-wrap gap-3 justify-end">
    <a href="/" class="px-4 py-2 rounded-lg border">Torna all'inizio</a>
    <button type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">
      Genera
    </button>
  </div>
</form>

{% if file_previews %}
  <div class="mt-10">
    <h2 class="text-xl font-bold">Anteprima contenuti caricati</h2>
    <div class="mt-3 grid gap-4">
      {% for f in file_previews %}
      <div class="p-4 rounded-lg border bg-white">
        <div class="font-medium">{{ f.name }}</div>
        <pre class="mt-2 text-sm whitespace-pre-wrap text-gray-700">{{ f.snippet }}</pre>
      </div>
      {% endfor %}
    </div>
  </div>
{% else %}
  <div class="mt-10">
    <div class="p-4 rounded-lg border bg-white text-gray-600">Nessuna anteprima ancora. Incolla testo, link o trascina uno o più file.</div>
  </div>
{% endif %}

{% if results %}
  <div class="mt-10">
    <h2 class="text-xl font-bold">Risultati per canale</h2>
    <div class="mt-4 grid gap-6">
      {% for ch, content in results.items() %}
      <div class="p-4 rounded-lg border bg-white">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">{{ ch }}</h3>
          <div class="flex gap-2">
            <a class="text-sm underline" href="/export?channel={{ ch }}&fmt=txt">Esporta .txt</a>
            <a class="text-sm underline" href="/export?channel={{ ch }}&fmt=html">Esporta .html</a>
            {% if ch == "Stampa" %}
              <a class="text-sm underline" href="/export?channel=Stampa&fmt=docx">Esporta .docx</a>
            {% endif %}
          </div>
        </div>

        {% if ch == "Social" and content is iterable and content is not string %}
          <ol class="mt-3 list-decimal ml-5 space-y-2">
            {% for part in content %}
              <li><pre class="whitespace-pre-wrap text-gray-900">{{ part }}</pre></li>
            {% endfor %}
          </ol>
        {% elif ch == "Social" %}
          <pre class="mt-3 whitespace-pre-wrap text-gray-900">{{ content }}</pre>
        {% else %}
          <div class="mt-3 prose max-w-none">{{ content | safe }}</div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
{% endif %}
{% endblock %}
