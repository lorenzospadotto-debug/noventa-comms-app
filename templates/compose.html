{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-bold">Carica o incolla, poi genera</h1>
{% set ai = profile.add_ai %}
{% if ai %}
  <div class="mt-2 p-3 border rounded bg-green-50 text-green-800 text-sm">AI attiva: i testi verranno rielaborati automaticamente (se possibile).</div>
{% endif %}

<form method="post" action="/generate" enctype="multipart/form-data" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6" onsubmit="showOverlay()">
  <div class="space-y-4">
    <label class="block">
      <span class="text-sm font-medium">Incolla qui un testo (opzionale). Usa <strong>grassetto</strong> e emoji.</span>
      <textarea name="text_input" rows="8" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-600" placeholder="Incolla qui..."></textarea>
    </label>

    <label class="block">
      <span class="text-sm font-medium">Oppure link di articolo</span>
      <input type="url" name="url_input" placeholder="https://…" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-600">
    </label>

    <div class="border-2 border-dashed rounded-lg p-6 text-center" id="dropzone" aria-live="polite">
      <p>Trascina qui uno o più file (PDF, DOCX, TXT) oppure clicca</p>
      <input id="file-input" type="file" name="files" multiple class="mt-3">
      <div id="local-previews" class="mt-4 text-left text-sm text-gray-600"></div>
    </div>

    <label class="inline-flex items-center gap-2 mt-2">
      <input type="checkbox" name="split_x">
      <span>Dividi automaticamente in thread da 280 per X</span>
    </label>

    <div class="flex gap-3 mt-2">
      <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold">Genera anteprime</button>
      <a href="/" class="px-4 py-2 rounded-lg border font-semibold">Torna all'inizio</a>
    </div>

    {% if errors and errors|length>0 %}
    <div class="p-3 border rounded bg-red-50 text-red-800 text-sm">
      <div class="font-semibold mb-1">Problemi durante l'upload/lettura file:</div>
      <ul class="list-disc ml-5">
        {% for e in errors %}<li>{{ e }}</li>{% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>

  <div class="space-y-4">
    {% if not results %}
      <div class="p-4 rounded-lg bg-white border text-gray-600">Nessuna anteprima ancora. Incolla testo, link o trascina uno o più file.</div>
    {% endif %}

    {% if file_previews and file_previews|length > 0 %}
    <div class="p-4 rounded-lg bg-white border">
      <h2 class="font-semibold mb-2">Anteprima contenuti caricati</h2>
      <div class="space-y-3 max-h-64 overflow-auto" aria-live="polite">
        {% for f in file_previews %}
          <div class="p-3 rounded border">
            <div class="font-mono text-sm text-gray-700">{{ f.name }}</div>
            <pre class="whitespace-pre-wrap text-sm text-gray-700">{{ f.snippet }}</pre>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if results %}
      {% for channel, content in results.items() %}
      <div class="p-4 rounded-lg bg-white border">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold text-lg">{{ channel }}</h2>
          <div class="flex gap-2">
            <button type="button" class="px-3 py-1 border rounded" onclick="copyBlock(this)">Copia</button>
            <a class="px-3 py-1 border rounded" href="/export?channel={{ channel }}&fmt=txt">.txt</a>
            <a class="px-3 py-1 border rounded" href="/export?channel={{ channel }}&fmt=html">.html</a>
            {% if channel == 'Stampa' %}<a class="px-3 py-1 border rounded" href="/export?channel={{ channel }}&fmt=docx">.docx</a>{% endif %}
          </div>
        </div>

        {% if content is string %}
          <div class="mt-3" data-copy-target="1">
            {% if channel == 'Social' %}
              <pre class="whitespace-pre-wrap text-sm">{{ content }}</pre>
            {% else %}
              <div class="prose prose-sm max-w-none">{{ content | safe }}</div>
            {% endif %}
          </div>
        {% else %}
          <div class="mt-3 space-y-3" data-copy-target="1">
            {% for p in content %}
              <div class="p-2 rounded border bg-gray-50 text-sm">{{ p }}</div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
      {% endfor %}
    {% endif %}
  </div>
</form>
{% endblock %}
