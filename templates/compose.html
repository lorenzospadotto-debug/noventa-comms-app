{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Carica o incolla, poi genera</h1>

<form method="post" action="/generate" enctype="multipart/form-data" onsubmit="showOverlay()"
      class="grid md:grid-cols-2 gap-6">
  <div>
    <label for="text_input" class="block text-sm font-medium mb-1">Incolla qui un testo (opzionale). Usa <strong>grassetto</strong> e emoji.</label>
    <textarea id="text_input" name="text_input" rows="8" class="w-full border rounded p-3" placeholder="Incolla qui..."></textarea>

    <label for="url_input" class="block text-sm font-medium mt-4 mb-1">Oppure link di articolo</label>
    <input id="url_input" name="url_input" type="url" class="w-full border rounded p-3" placeholder="https://...">

    <div class="mt-4 border-2 border-dashed rounded p-4">
      <div class="text-sm text-gray-600 mb-2">Trascina qui uno o più file (PDF, DOCX, TXT) oppure clicca</div>
      <input type="file" id="files" name="files" multiple class="block">
      <div id="previews" class="mt-2 space-y-2 text-sm" aria-live="polite"></div>
    </div>

    <label class="flex items-center gap-2 mt-3">
      <input type="checkbox" name="split_x" id="split_x">
      <span>Dividi automaticamente in thread da 280 per X</span>
    </label>

    <button class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded">Genera anteprime</button>
    <a href="/" class="ml-2 px-4 py-2 bg-gray-100 rounded">Torna all'inizio</a>

    <p class="text-xs text-gray-500 mt-3">
      Modalità AI: <strong>
      {% if (request.session.get('profile') or {}).get('add_ai') %}ATTIVA{% else %}SPENTA{% endif %}
      </strong>
      {% if not (request.session.get('profile') or {}).get('add_ai') and not (request.session.get('style_guide') or '') %}
        — attiva in <a class="underline" href="/profile">Profilo</a>.
      {% endif %}
    </p>
  </div>

  <div>
    {% if errors and errors|length>0 %}
      <div class="bg-red-50 border border-red-200 text-red-800 p-3 rounded mb-4">
        {% for e in errors %}<div>• {{ e }}</div>{% endfor %}
      </div>
    {% endif %}

    <div class="mb-4">
      <div class="text-sm font-semibold mb-1">Anteprima contenuti caricati</div>
      <div class="border rounded p-3 text-sm bg-white">
        {% if file_previews and file_previews|length>0 %}
          {% for f in file_previews %}
            <div class="mb-3">
              <div class="font-medium">{{ f.name }}</div>
              <pre class="whitespace-pre-wrap">{{ f.snippet }}</pre>
            </div>
          {% endfor %}
        {% else %}
          (File non elaborato)
        {% endif %}
      </div>
    </div>

    {% if results %}
      {% for ch, content in results.items() %}
        <div class="mb-4 border rounded p-3 bg-white">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">{{ ch }}</h2>
            <div class="space-x-2">
              <a class="px-2 py-1 border rounded" href="/export?channel={{ ch }}&fmt=txt">.txt</a>
              <a class="px-2 py-1 border rounded" href="/export?channel={{ ch }}&fmt=html">.html</a>
              {% if ch == "Stampa" %}
                <a class="px-2 py-1 border rounded" href="/export?channel={{ ch }}&fmt=docx">.docx</a>
              {% endif %}
            </div>
          </div>
          {% if content is sequence and content is not string %}
            <ul class="list-disc pl-5">
              {% for item in content %}<li>{{ item }}</li>{% endfor %}
            </ul>
          {% else %}
            <div class="prose max-w-none">
              {{ content | safe }}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% endif %}
  </div>
</form>

<script>
  // Anteprima rapida lato client (solo nomi)
  const input = document.getElementById('files');
  const previews = document.getElementById('previews');

  function renderPreviews(files){
    previews.innerHTML = "";
    Array.from(files).forEach(f => {
      const div = document.createElement('div');
      div.className = "border rounded p-2 bg-white";
      div.textContent = f.name + " (pronto per l'invio)";
      previews.appendChild(div);
    });
  }

  input.addEventListener('change', e => renderPreviews(e.target.files));

  // Supporto drag&drop sul container dashed
  const dashed = input.parentElement;
  dashed.addEventListener('dragover', e => { e.preventDefault(); dashed.classList.add('ring-2','ring-indigo-400'); });
  dashed.addEventListener('dragleave', () => dashed.classList.remove('ring-2','ring-indigo-400'));
  dashed.addEventListener('drop', e => {
    e.preventDefault(); dashed.classList.remove('ring-2','ring-indigo-400');
    if (e.dataTransfer.files.length){
      const dt = new DataTransfer();
      Array.from(e.dataTransfer.files).forEach(f => dt.items.add(f));
      input.files = dt.files;                    // IMPORTANTE: li mettiamo nell'input per il submit
      renderPreviews(input.files);
    }
  });

  function showOverlay(){document.getElementById('overlay')?.classList.remove('hidden')}
</script>
{% endblock %}
